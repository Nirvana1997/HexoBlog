---
title: 游戏服务器的网络协议
category:
  - 网络
tags:
  - 网络传输协议
  - TCP
  - UDP
  - KCP
date: 2018-08-19 22:13:01
---

## 1.前言

来到公司后了解到我们的游戏服务器是使用tcp协议进行通信的,使用epoll来监听和处理socket.网络协议会一定程度游戏数据的网络传输的效率、安全性、完整性、顺序性等,因此网络协议的选择一定要恰当.

<!--more-->

## 2.TCP与UDP

###(i).区别

大概回忆下TCP与UDP的主要区别:

1. tcp面向连接,提供可靠服务;udp无连接,尽最大可能交付.tcp对于发送失败的包的会进行重传,所以tcp的服务相比udp**可靠性**更强.
2. tcp实现较为复杂,虽然**使用方便**,但是在使用时想修改起来非常麻烦,无法做到自定义地制定一些规则.udp本身十分简单,没有握手、重传等的机制,只是简单地将数据报发送至网路上,但这样也使得udp的**可修改性**很强,基于udp可以实现项目需要的可靠性、流量控制等功能.感觉tcp和udp的这点区别类似于java和c++,使用java时不需要关心内存管理,但你也无法像c++那样去控制它的内存管理.
3. tcp为了保证可靠性,引入滑动窗口、握手等的机制,所以会影响传输数据的效率,相比udp**效率**会偏低.

### (ii).选择

其实这些区别在应用在游戏服务器上时,区别主要就体现在**延迟**上了.

在网络情况良好的情况下,两种协议其实没太大区别,但当网络情况拥堵,开始发生丢包时,使用tcp则会重传,保证包都发送成功,但同时会引起延迟.使用udp可以有效改善丢包引起的延迟,但丢失的包是不会重传的,但可以通过编程的方式实现重传.

所以一般来说,tcp和udp的选择主要考虑的就是对**延迟的可容忍程度**.

* 当对游戏的延迟不太可容忍时,如一些实时交互的游戏,MOBA和FPS游戏,那么udp比较合适
* 当对游戏的延迟可以容忍时,如一些卡牌游戏,那么使用tcp就比较方便

但也只能说是比较合适,并不是绝对的.比如魔兽世界wow就是使用tcp作为传输协议的.说实话知道这点的时候还是比较意外的.不过经过查阅资料,发现wow会有隐藏这种延迟的办法.

> 玩家的攻击指令发送给服务器的操作是放在比如“**attack_entity(entity_id)**”或者”**cast_spell(entity_id, spell_id)**“的接口中来做的，换句话说，瞄准操作是独立于进行的。如此一来，一些类似发起攻击动作和释放技能特效就能够在没有收到服务器确认的情况下就直接执行，比如展现冰冻技能的效果就可以在服务器没有返回数据前在客户端就做出来。

我们的游戏也是mmorpg,也是具有实时性的,也会有类似的处理.比如我们的商店列表,是在登录时发送至前端,然后在前端缓存,当发生变化时再由服务器发送通知客户端更新,购买时再在后端进行验证,通过才会进行购买动作.

总的来说,就是尽可能把关于展示的计算放在客户端,服务器负责变化时的同步与动作的验证,这样可以规避一些延迟带来的影响.

## 3.可靠UDP

基于udp我们可以根据需要来实现可靠性、流量控制等功能,很多时候可以有比tcp很低的延迟、更高的可控性.

现在已经有一些开源的可靠传输协议:QUIC、ENET、KCP、UDT.其中KCP是国内开发的,而且表现很不错,所以我去研究了一哈~主要参考[KCP的官网文档](https://github.com/skywind3000/kcp)

其实kcp主要做的是在底层协议(一般是udp)的基础上,加上一层对丢失的数据包进行重发,来保证可靠性.与tcp相比,kcp对一些处理进行了一些改良,从而在保证可靠性的同时加快了传输效率.官方文档中有提到kcp的一些特殊处理:

>TCP是为流量设计的（每秒内可以传输多少KB的数据），讲究的是充分利用带宽。而 KCP是为流速设计的（单个数据包从一端发送到一端需要多少时间），以10%-20%带宽浪费的代价换取了比 TCP快30%-40%的传输速度。TCP信道是一条流速很慢，但每秒流量很大的大运河，而KCP是水流湍急的小激流。KCP有正常模式和快速模式两种，通过以下策略达到提高流速的结果：<br></br>
>
>#### RTO翻倍vs不翻倍：
>
> TCP超时计算是RTOx2，这样连续丢三次包就变成RTOx8了，十分恐怖，而KCP启动快速模式后不x2，只是x1.5（实验证明1.5这个值相对比较好），提高了传输速度。<br></br>
>
>#### 选择性重传 vs 全部重传：
>
>TCP丢包时会全部重传从丢的那个包开始以后的数据，KCP是选择性重传，只重传真正丢失的数据包。<br></br>
>
>#### 快速重传：
>
>发送端发送了1,2,3,4,5几个包，然后收到远端的ACK: 1, 3, 4, 5，当收到ACK3时，KCP知道2被跳过1次，收到ACK4时，知道2被跳过了2次，此时可以认为2号丢失，不用等超时，直接重传2号包，大大改善了丢包时的传输速度。<br></br>
>
>#### 延迟ACK vs 非延迟ACK：
>
>TCP为了充分利用带宽，延迟发送ACK（NODELAY都没用），这样超时计算会算出较大 RTT时间，延长了丢包时的判断过程。KCP的ACK是否延迟发送可以调节。<br></br>
>
>#### UNA vs ACK+UNA：
>
>ARQ模型响应有两种，UNA（此编号前所有包已收到，如TCP）和ACK（该编号包已收到），光用UNA将导致全部重传，光用ACK则丢失成本太高，以往协议都是二选其一，而 KCP协议中，除去单独的 ACK包外，所有包都有UNA信息。<br></br>
>
>#### 非退让流控：
>
>KCP正常模式同TCP一样使用公平退让法则，即发送窗口大小由：发送缓存大小、接收端剩余接收缓存大小、丢包退让及慢启动这四要素决定。但传送及时性要求很高的小数据时，可选择通过配置跳过后两步，仅用前两项来控制发送频率。以牺牲部分公平性及带宽利用率之代价，换取了开着BT都能流畅传输的效果。

## 4.总结

总的来说,选用何种传输协议,还是要因地制宜,根据游戏实际情况以及一些实验测试来决定.

//不过我也没有做过实验(✺ω✺),主要参考了以下文章~

[游戏服务器：到底使用UDP还是TCP](http://blog.jobbole.com/64638/)

[为什么MOBA、“吃鸡”游戏不推荐用tcp协议——实测数据](http://gad.qq.com/article/detail/37876)

[kcp协议详解](https://www.cnblogs.com/yuanyifei1/p/6846310.html)

