---
title: proto2和proto3兼容的一次尝试
category:
  - protobuf
tags:
  - c++
  - protobuf
date: 2021-04-01 17:12:42
---

## 1.前言

由于项目可能会需要proto3的某些特性，但是当前项目中使用的是proto2，因此我这次开始了proto2升级proto3的历程。标题是一次尝试，那是十有八九我是失败了(╥╯^╰╥)，但通过这次失败还是总结出了一丢丢结论，故书此篇。

## 2.proto2与proto3的区别

### i.移除了default选项

proto3中不再能指定default值，未赋值则使用默认的“0”值。

这一定程度上影响了proto协议的灵活性，项目中还是有一些字段在使用非0的default值后可以减少代码量，使代码简洁明了。

但是这提高了proto的兼容性和稳定性，项目中不同版本的proto可能会改变default值，假如默认值不是0，使用proto通信的两端版本不一致，很有可能会产生一些难以定位的问题。同时，proto3中，设置某字段值为默认值时，在序列化后，该字段是不会占用空间的，这对于性能的提升还是有很大帮助的，此次尝试也主要是想使用这个特性

。。。

## 3.proto2与proto3的兼容

由于当前项目本身使用的是proto2，规模较大，不太可能整体换成proto3，因此需要考虑2和3的兼容问题。首先

